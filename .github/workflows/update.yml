name: Scheduled Update
on:
  schedule:
    - cron: "0 0 * * sun"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          # go to Account / Settings > Developer Settings > Personal access tokens
          # then create one with permission: Content WRITE
          token: ${{ secrets.SELF_CONTENT_WRITE_TOKEN }}
      - uses: cachix/install-nix-action@v27
        with:
          nix_path: "nixpkgs=flake:nixpkgs"
      - run: nix flake update
      # quick sanity: update only; matrix builds run below
      - run: nix flake check || true
  build-hm:
    runs-on: ubuntu-latest
    needs: update
    strategy:
      fail-fast: false
      matrix:
        target: [
          "aster@amberwood",
          "aster@amberwood-wsl",
          "aster@bogster",
          "aster@carbon",
          "aster@carbon-wsl",
          "aster@dusk"
        ]
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v27
        with:
          nix_path: "nixpkgs=flake:nixpkgs"
      - run: nix run nixpkgs#home-manager -- build --flake .#${{ matrix.target }}
  build-nixos:
    runs-on: ubuntu-latest
    needs: update
    strategy:
      fail-fast: false
      matrix:
        host: [amberwood, bogster, carbon, dusk]
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v27
        with:
          nix_path: "nixpkgs=flake:nixpkgs"
      - run: nix run nixpkgs#nixos-rebuild -- build --flake .#${{ matrix.host }}
      - uses: EndBug/add-and-commit@v9
        with:
          message: "(bot)schedule: update flake"
          committer_name: GitHub Actions
          committer_email: 41898282+github-actions[bot]@users.noreply.github.com
